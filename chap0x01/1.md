# 实验一：OpenWrt on VirtualBox  
## 实验目的  
1. 熟悉基于 OpenWrt 的无线接入点（AP）配置  
2. 为第二章、第三章和第四章实验准备好「无线软 AP」环境  
## 实验要求  
1. 对照第一章实验`无线路由器/无线接入点（AP）配置`列的功能清单，找到在`OpenWrt`中的配置界面并截图证明  
2. 记录环境搭建步骤  
3. 如果 USB 无线网卡能在`OpenWrt`中正常工作，则截图证明  
4. 如果 USB 无线网卡不能在`OpenWrt`中正常工作，截图并分析可能的故障原因并给出可能的解决方法  
## 实验环境  
1. Virtualbox  
2. 可以开启监听模式、AP 模式和数据帧注入功能的 USB 无线网卡  
## 实验过程  
### 复习VirtualBox的配置与使用  
1. 虚拟机镜像列表  
2. 设置虚拟机和宿主机的文件共享，实现宿主机和虚拟机的双向文件共享  
![文件共享](./img/文件共享.png)  
3. 虚拟机镜像备份和还原的方法  
![备份](./img/备份.png)  
4. 熟悉虚拟机基本网络配置，了解不同联网模式的典型应用场景  
### OpenWrt on VirtualBox  
1. 下载[openwrt-19.07.5-x86-64-combined-squashfs.img.gz](https://downloads.openwrt.org/releases/19.07.5/targets/x86/64/openwrt-19.07.5-x86-64-combined-squashfs.img.gz)  
2. `gunzip openwrt-19.07.5-x86-64-combined-squashfs.img.gz`解压缩  
3. `VBoxManage convertfromraw --format VDI openwrt-19.07.5-x86-64-combined-squashfs.img openwrt-x86-64-combined-squashfs.vdi`转换格式  
    * 转换格式过程中如果出现`VBoxManage`报错  
    可以按照bash脚本中[提示信息](https://openwrt.org/docs/guide-user/virtualization/virtualbox-vm#convert_openwrtimg_to_vbox_drive)执行`dd`命令  
    `dd if=openwrt-19.07.5-x86-64-combined-squashfs.img of=openwrt-19.07.5-x86-64-combined-squashfs-padded.img bs=128000 conv=sync`  
    
   ![格式转换成功](./img/格式转换成功.png)  
4. 创建`OpenWrt`虚拟机  
![创建虚拟机](./img/新建虚拟机.png)  
镜像类型为多重加载/虚拟磁盘扩容/网卡按照要求进行配置/启用USB 3.0接口  
虚拟机网卡的配置情况：  
    * 第一块网卡设置为：Intel PRO/1000 MT 桌面（仅主机(Host-Only)网络）  
    * 第二块网卡设置为：Intel PRO/1000 MT 桌面（网络地址转换(NAT)）  
5. 启动`OpenWrt`虚拟机  
![启动虚拟机](./img/开启openwrt.png)  
6. 修改`/etc/config/network`  
`ifdown eth0 && ifup eth0`重启网卡使得修改生效  
7. 访问IP地址登录管理界面  
![登录管理界面](./img/登录界面.png)  
### 开启 AP 功能  
`opkg update && opkg install usbutils`安装usbutils  
安装好`usbutils`之后，通过以下 2 个步骤可以确定该无线网卡的驱动是否已经安装好  
```
# 查看 USB 外设的标识信息
lsusb
# 查看 USB 外设的驱动加载情况
lsusb -t
```  
```
#快速查找可能包含指定芯片名称的驱动程序包
opkg find kmod-* | grep 9271
#a安装驱动
opkg install kmod-ath9k-htc
```  
默认情况下，OpenWrt 只支持`WEP`系列过时的无线安全机制，为了让 OpenWrt 支持`WPA`系列更安全的无线安全机制，还需要额外安装 2 个软件包：`wpa-supplicant`和` hostapd`，其中`wpa-supplicant`提供 WPA 客户端认证，`hostapd`提供 AP 或 ad-hoc 模式的 WPA 认证  
`opkg install hostapd wpa-supplicant`安装hostapd wpa-supplicant  
配置成功，重启后生效  
![配置成功](./img/配置成功.png)  
无线网络配置尝试  
![无线网络配置](./img/网络配置.png)  

### 无线路由器/无线接入点（AP）配置清单检查  
* 重置和恢复AP到出厂默认设置状态  
![重置和恢复AP到出厂默认设置状态](./img/重置和恢复AP到出厂默认设置状态.png)  
* 设置AP的管理员用户名和密码  
![设置AP的管理员用户名和密码](./img/设置AP的管理员用户名和密码.png)  
* 设置SSID广播和非广播模式  
![设置SSID广播和非广播模式](./img/设置SSID广播和非广播模式.png)  
* 配置不同的加密方式  
![配置不同的加密方式](./img/配置不同的加密方式.png)  
* 设置AP管理密码  
![设置AP管理密码](./img/设置AP管理密码.png)  
* 配置无线路由器使用自定义的DNS解析服务器  
![配置无线路由器使用自定义的DNS解析服务器](./img/配置无线路由器使用自定义的DNS解析服务器.png)  
* 配置DHCP和禁用DHCP  
![配置DHCP和禁用DHCP](./img/配置DHCP和禁用DHCP.png)  
* 开启路由器/AP的日志记录功能（对指定事件记录）  
![开启路由器/AP的日志记录功能](./img/开启路由器AP的日志记录功能.png)  
* 配置AP隔离(WLAN划分)功能  
![配置AP隔离](./img/配置AP隔离.png)  
* 设置MAC地址过滤规则（ACL地址过滤器）  
![设置MAC地址过滤规则](./img/设置MAC地址过滤规则.png)  
* 查看WPS功能的支持情况  
![查看WPS功能的支持情况](./img/查看WPS功能的支持情况.png)  
* 查看AP/无线路由器支持哪些工作模式  
![查看AP](./img/查看AP.png)  

## 参考资料  
[教材第一章实验](https://c4pr1c3.github.io/cuc-mis/chap0x01/exp.html)  
[在VM上安装OpenWrt](https://www.cnblogs.com/HOsystem/p/11741114.html)  
[openwrt-19.07.5-x86-64-combined-squashfs.img.gz](https://downloads.openwrt.org/releases/19.07.5/targets/x86/64/openwrt-19.07.5-x86-64-combined-squashfs.img.gz)  
[提示信息](https://openwrt.org/docs/guide-user/virtualization/virtualbox-vm#convert_openwrtimg_to_vbox_drive)
